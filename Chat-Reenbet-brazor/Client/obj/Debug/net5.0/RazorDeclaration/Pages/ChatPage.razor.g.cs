// <auto-generated/>
#pragma warning disable 1591
#pragma warning disable 0414
#pragma warning disable 0649
#pragma warning disable 0169

namespace Chat_Reenbet_brazor.Client.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.WebAssembly.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.ComponentModel.DataAnnotations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Collections;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.SignalR.Client;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/chatpage/{chatId}")]
    public partial class ChatPage : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
        }
        #pragma warning restore 1998
#nullable restore
#line 40 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
 
    [Parameter]
    public string chatId { get; set; }
    private HubConnection hubConnection;
    private List<Message> messages = new List<Message>();
    private string userName = string.Empty;
    private string message = string.Empty;
    private int loaded = 0;
    ElementReference TextSpaceRef;
    private bool allLoaded = false;
    private Chat chat = new Chat();

    private async Task Send()
    {
        
        string author = await LocalStorage.GetItemAsStringAsync("user_login");
        author = author.Trim('"');

         await hubConnection.SendAsync("SendMessage", message, author, chatId); 
        loaded += 1;
    }

    private async Task RemoveMessage(Guid messageId)
    {
        await hubConnection.SendAsync("RemoveMessage", messageId); 
        StateHasChanged();
    }

    private async Task EditMessage(Guid messageId)
    {
        await hubConnection.SendAsync("EditMessage", messageId, message); 
        StateHasChanged();
    }

    private async Task LoadMore()
    {
        await hubConnection.InvokeAsync("GetMassagePack", chatId, loaded, Convert.ToString(hubConnection));
        StateHasChanged();
    }

    private async Task ReplyMessage(Guid replyId)
    {
        string author = await LocalStorage.GetItemAsStringAsync("user_login");
        author = author.Trim('"');
        System.Console.WriteLine(replyId);
        await hubConnection.SendAsync("ReplyMessage", message, author, chatId, replyId); 
        loaded += 1;
    }

    private async Task GetMessagePack()
    {
        await hubConnection.SendAsync("GetMassagePack", chatId, loaded); 
        loaded += 20;
    }

   private async Task Connect()
   {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(navigationManager.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<Message>("AddMessage", (msg) => 
            {
                messages.Add(msg); 
                StateHasChanged();
                JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);
            });

            hubConnection.On<Message>("AddReply", (rpl) => 
            {
                System.Console.WriteLine(rpl); 
                messages.Add(rpl);
                StateHasChanged();
                JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);
            });

        hubConnection.On<IList<Message>>("AddMessagePack", (pack =>
            {
                System.Console.WriteLine(pack.Count);
                  messages.InsertRange(0, pack);
                  StateHasChanged();
                  loaded += 20;
                  
            }));

        await hubConnection.StartAsync();

        System.Console.WriteLine("Connected to hub");
   }
 
    protected override async Task OnParametersSetAsync()
    {
        if(hubConnection != null)
        {
            await hubConnection.InvokeAsync("LeaveRoom", chat.Id);
        }
        
        chat = await chatService.GetChatById(Guid.Parse(chatId));

        await Connect();

        StateHasChanged();

        messages.Clear();

        loaded = 0;

        allLoaded = false;
        
        await hubConnection.InvokeAsync("JoinRoom", chatId);

        System.Console.WriteLine("joined room");

        await hubConnection.InvokeAsync("GetMassagePack", chatId, loaded, Convert.ToString(hubConnection));

        await JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);

        allLoaded = true;
        //System.Console.WriteLine(messages.Count);

    }
 

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILocalStorageService LocalStorage { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IChatService chatService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager navigationManager { get; set; }
    }
}
#pragma warning restore 1591
