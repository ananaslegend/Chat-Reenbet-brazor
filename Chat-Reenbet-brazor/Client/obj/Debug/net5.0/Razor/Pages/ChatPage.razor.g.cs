#pragma checksum "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor" "{ff1816ec-aa5e-4d10-87f7-6f4963833460}" "52ba26b82218cf15f84bbf37654347bbe1276dfb"
// <auto-generated/>
#pragma warning disable 1591
namespace Chat_Reenbet_brazor.Client.Pages
{
    #line hidden
    using System;
    using System.Collections.Generic;
    using System.Linq;
    using System.Threading.Tasks;
    using Microsoft.AspNetCore.Components;
#nullable restore
#line 1 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Net.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 2 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Net.Http.Json;

#line default
#line hidden
#nullable disable
#nullable restore
#line 3 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Forms;

#line default
#line hidden
#nullable disable
#nullable restore
#line 4 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Routing;

#line default
#line hidden
#nullable disable
#nullable restore
#line 5 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Web;

#line default
#line hidden
#nullable disable
#nullable restore
#line 6 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Web.Virtualization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 7 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.WebAssembly.Http;

#line default
#line hidden
#nullable disable
#nullable restore
#line 8 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.JSInterop;

#line default
#line hidden
#nullable disable
#nullable restore
#line 9 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client;

#line default
#line hidden
#nullable disable
#nullable restore
#line 10 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client.Shared;

#line default
#line hidden
#nullable disable
#nullable restore
#line 11 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Models;

#line default
#line hidden
#nullable disable
#nullable restore
#line 12 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.ComponentModel.DataAnnotations;

#line default
#line hidden
#nullable disable
#nullable restore
#line 13 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Blazored.LocalStorage;

#line default
#line hidden
#nullable disable
#nullable restore
#line 14 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 15 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.Components.Authorization;

#line default
#line hidden
#nullable disable
#nullable restore
#line 16 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using System.Collections;

#line default
#line hidden
#nullable disable
#nullable restore
#line 17 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Chat_Reenbet_brazor.Client.Services;

#line default
#line hidden
#nullable disable
#nullable restore
#line 18 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\_Imports.razor"
using Microsoft.AspNetCore.SignalR.Client;

#line default
#line hidden
#nullable disable
    [Microsoft.AspNetCore.Components.RouteAttribute("/chatpage/{chatId}")]
    public partial class ChatPage : Microsoft.AspNetCore.Components.ComponentBase
    {
        #pragma warning disable 1998
        protected override void BuildRenderTree(Microsoft.AspNetCore.Components.Rendering.RenderTreeBuilder __builder)
        {
            __builder.OpenElement(0, "h1");
#nullable restore
#line 7 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(1, chat.Name);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
#nullable restore
#line 8 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
 if (@allLoaded == false)
{

#line default
#line hidden
#nullable disable
            __builder.AddMarkupContent(2, "<h3>Loading...</h3>");
#nullable restore
#line 11 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
}
else
{

#line default
#line hidden
#nullable disable
            __builder.OpenElement(3, "div");
            __builder.AddAttribute(4, "style", "width: 100%; height: 500px; border-style: groove; overflow-y:scroll; word-break: break-word;");
            __builder.AddElementReferenceCapture(5, (__value) => {
#nullable restore
#line 14 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                                                                                                                   TextSpaceRef = __value;

#line default
#line hidden
#nullable disable
            }
            );
            __builder.OpenElement(6, "button");
            __builder.AddAttribute(7, "class", "btn btn-primary");
            __builder.AddAttribute(8, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 15 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                                                  LoadMore

#line default
#line hidden
#nullable disable
            ));
            __builder.AddContent(9, "Load More");
            __builder.CloseElement();
#nullable restore
#line 16 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
      foreach (var msg in messages)
     {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(10, "div");
            __builder.OpenElement(11, "p");
            __builder.OpenElement(12, "span");
#nullable restore
#line 18 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(13, msg.Author.Login);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddContent(14, " at ");
            __builder.OpenElement(15, "span");
            __builder.AddAttribute(16, "style", "font-size: 90%;");
#nullable restore
#line 18 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(17, msg.Date.Hour);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddContent(18, ":");
            __builder.OpenElement(19, "span");
            __builder.AddAttribute(20, "style", "font-size: 90%;");
#nullable restore
#line 18 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(21, msg.Date.Minute);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddMarkupContent(22, " &#9 ");
            __builder.OpenElement(23, "span");
            __builder.AddAttribute(24, "style", "font-size: 75%;\r\n");
#nullable restore
#line 19 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(25, msg.Date.ToShortDateString());

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddMarkupContent(26, "<br>");
            __builder.OpenElement(27, "span");
#nullable restore
#line 19 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(28, msg.Data);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.OpenElement(29, "button");
            __builder.AddAttribute(30, "class", "btn");
            __builder.AddAttribute(31, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 19 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                                                                                                () => EditMessage(msg.Id)

#line default
#line hidden
#nullable disable
            ));
            __builder.AddContent(32, "Edit");
            __builder.CloseElement();
            __builder.OpenElement(33, "button");
            __builder.AddAttribute(34, "class", "btn");
            __builder.AddAttribute(35, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 19 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                                                                                                                                                                      () => RemoveMessage(msg.Id)

#line default
#line hidden
#nullable disable
            ));
            __builder.AddContent(36, "Remove");
            __builder.CloseElement();
            __builder.OpenElement(37, "button");
            __builder.AddAttribute(38, "class", "btn");
            __builder.AddAttribute(39, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 19 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                                                                                                                                                                                                                                                () => ReplyMessage(msg.Id)

#line default
#line hidden
#nullable disable
            ));
            __builder.AddContent(40, "Reply");
            __builder.CloseElement();
            __builder.CloseElement();
#nullable restore
#line 20 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
     if (msg.Reply != null)
    {

#line default
#line hidden
#nullable disable
            __builder.OpenElement(41, "p");
            __builder.AddAttribute(42, "style", "font-size: 90%;");
            __builder.AddMarkupContent(43, "&#129045 Reply to ");
            __builder.OpenElement(44, "span");
#nullable restore
#line 22 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(45, msg.Reply.Author.Login);

#line default
#line hidden
#nullable disable
            __builder.AddContent(46, ":");
            __builder.CloseElement();
            __builder.OpenElement(47, "span");
#nullable restore
#line 22 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
__builder.AddContent(48, msg.Reply.Data);

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.CloseElement();
#nullable restore
#line 23 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
    }

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
#nullable restore
#line 25 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
     }

#line default
#line hidden
#nullable disable
            __builder.CloseElement();
            __builder.AddMarkupContent(49, "\r\n ");
            __builder.OpenElement(50, "div");
            __builder.AddAttribute(51, "class", "input-group");
            __builder.OpenElement(52, "input");
            __builder.AddAttribute(53, "class", "form-controll");
            __builder.AddAttribute(54, "value", Microsoft.AspNetCore.Components.BindConverter.FormatValue(
#nullable restore
#line 28 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
                         message

#line default
#line hidden
#nullable disable
            ));
            __builder.AddAttribute(55, "oninput", Microsoft.AspNetCore.Components.EventCallback.Factory.CreateBinder(this, __value => message = __value, message));
            __builder.SetUpdatesAttributeName("value");
            __builder.CloseElement();
            __builder.AddMarkupContent(56, "\r\n     ");
            __builder.OpenElement(57, "button");
            __builder.AddAttribute(58, "class", "btn btn-primary form-group-append");
            __builder.AddAttribute(59, "onclick", Microsoft.AspNetCore.Components.EventCallback.Factory.Create<Microsoft.AspNetCore.Components.Web.MouseEventArgs>(this, 
#nullable restore
#line 32 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
               Send

#line default
#line hidden
#nullable disable
            ));
            __builder.AddMarkupContent(60, "\r\n         Send\r\n     ");
            __builder.CloseElement();
            __builder.CloseElement();
#nullable restore
#line 36 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
}

#line default
#line hidden
#nullable disable
        }
        #pragma warning restore 1998
#nullable restore
#line 40 "D:\Projects\Chat-Reenbet-brazor\Chat-Reenbet-brazor\Client\Pages\ChatPage.razor"
 
    [Parameter]
    public string chatId { get; set; }
    private HubConnection hubConnection;
    private List<Message> messages = new List<Message>();
    private string userName = string.Empty;
    private string message = string.Empty;
    private int loaded = 0;
    ElementReference TextSpaceRef;
    private bool allLoaded = false;
    private Chat chat = new Chat();

    private async Task Send()
    {
        
        string author = await LocalStorage.GetItemAsStringAsync("user_login");
        author = author.Trim('"');

         await hubConnection.SendAsync("SendMessage", message, author, chatId); 
        loaded += 1;
    }

    private async Task RemoveMessage(Guid messageId)
    {
        await hubConnection.SendAsync("RemoveMessage", messageId); 
        StateHasChanged();
    }

    private async Task EditMessage(Guid messageId)
    {
        await hubConnection.SendAsync("EditMessage", messageId, message); 
        StateHasChanged();
    }

    private async Task LoadMore()
    {
        await hubConnection.InvokeAsync("GetMassagePack", chatId, loaded, Convert.ToString(hubConnection));
        StateHasChanged();
    }

    private async Task ReplyMessage(Guid replyId)
    {
        string author = await LocalStorage.GetItemAsStringAsync("user_login");
        author = author.Trim('"');
        System.Console.WriteLine(replyId);
        await hubConnection.SendAsync("ReplyMessage", message, author, chatId, replyId); 
        loaded += 1;
    }

    private async Task GetMessagePack()
    {
        await hubConnection.SendAsync("GetMassagePack", chatId, loaded); 
        loaded += 20;
    }

   private async Task Connect()
   {
        hubConnection = new HubConnectionBuilder()
            .WithUrl(navigationManager.ToAbsoluteUri("/chathub"))
            .Build();

        hubConnection.On<Message>("AddMessage", (msg) => 
            {
                messages.Add(msg); 
                StateHasChanged();
                JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);
            });

            hubConnection.On<Message>("AddReply", (rpl) => 
            {
                System.Console.WriteLine(rpl); 
                messages.Add(rpl);
                StateHasChanged();
                JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);
            });

        hubConnection.On<IList<Message>>("AddMessagePack", (pack =>
            {
                System.Console.WriteLine(pack.Count);
                  messages.InsertRange(0, pack);
                  StateHasChanged();
                  loaded += 20;
                  
            }));

        await hubConnection.StartAsync();

        System.Console.WriteLine("Connected to hub");
   }
 
    protected override async Task OnParametersSetAsync()
    {
        if(hubConnection != null)
        {
            await hubConnection.InvokeAsync("LeaveRoom", chat.Id);
        }
        
        chat = await chatService.GetChatById(Guid.Parse(chatId));

        await Connect();

        StateHasChanged();

        messages.Clear();

        loaded = 0;

        allLoaded = false;
        
        await hubConnection.InvokeAsync("JoinRoom", chatId);

        System.Console.WriteLine("joined room");

        await hubConnection.InvokeAsync("GetMassagePack", chatId, loaded, Convert.ToString(hubConnection));

        await JSRuntime.InvokeVoidAsync("scrollToBottom", TextSpaceRef);

        allLoaded = true;
        //System.Console.WriteLine(messages.Count);

    }
 

#line default
#line hidden
#nullable disable
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IJSRuntime JSRuntime { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private ILocalStorageService LocalStorage { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private IChatService chatService { get; set; }
        [global::Microsoft.AspNetCore.Components.InjectAttribute] private NavigationManager navigationManager { get; set; }
    }
}
#pragma warning restore 1591
